# PETS + IRG 原理说明与实验结果解读（加强版）

本文档结合项目实现细节与两篇文献核心内容，完整说明 IRG 与 PETS 的方法原理、训练流程、关键超参与实验曲线含义，可直接用于论文“方法与实验分析”部分。

---

## 1. 任务背景与实验设定
**任务**：Source-Free Domain Adaptive Object Detection（SFOD）。  
**目标**：在不访问源域数据的前提下，将源域预训练模型适配到目标域。  
**本实验任务**：Cityscapes → FoggyCityscapes（C2F）。

**数据使用方式**：
- **Cityscapes** 仅用于训练好的源模型权重（/root/autodl-tmp/model_final.pth）。
- **FoggyCityscapes** 作为唯一训练数据（无标注），通过伪标签自训练。

**核心挑战**：目标域无标签导致伪标签噪声大、训练不稳定。  
**解决方案**：融合 IRG（关系结构一致性）与 PETS（双教师共识与周期交换）。

---

## 2. IRG：Instance Relation Graph 机制
IRG 的目标是**用实例关系结构约束伪标签训练**，提高目标域学习稳定性。

### 2.1 原理概述
将 ROI 特征作为图节点，通过 GCN 建模实例间关系。  
在学习过程中，要求学生与教师不仅在分类/回归层一致，还要在“关系结构”上保持一致。

### 2.2 与代码的对应
对应文件：`detectron2/modeling/meta_arch/student_sfda_rcnn.py`

关键模块：
- `GraphCN`：对 ROI 特征进行图卷积
- `Graph_conloss`：跨模型图结构一致性损失

关键损失项（训练日志可见）：
- `st_const`：学生 vs 教师 ROI 预测一致性
- `s_graph_const`：学生图预测 vs 学生 ROI 一致性
- `t_graph_const`：教师图预测 vs 教师 ROI 一致性
- `graph_conloss`：跨模型图结构一致性

### 2.3 作用与意义
- **抑制噪声**：关系结构比单个实例标签更稳定
- **稳定训练**：降低伪标签漂移造成的训练震荡
- **提升一致性**：教师与学生在特征结构层面更一致

---

## 3. PETS：Periodically Exchange Teacher-Student 机制
PETS 的目标是**提升伪标签质量**，同时避免学生陷入局部最优。

### 3.1 三模型角色
1) **静态教师（ST）**：每个 epoch 内固定  
2) **动态教师（DT）**：每个 iter 由学生 EMA 更新  
3) **学生（S）**：使用伪标签训练  

### 3.2 训练流程（论文严格版）
1) **Warm-up（前 2 个 epoch）**  
   - ST 固定不变  
   - DT 由 EMA 更新  
   - 学生用 ST+DT 共识伪标签训练  

2) **交换阶段（第 3 个 epoch 开始）**  
   - 每个 epoch 结束，交换 S 与 ST 权重（EXCHANGE_PERIOD=1）  
   - DT 继续 EMA 更新  

### 3.3 共识伪标签（Filtering + Fusion）
**Filtering：**  
对 ST 与 DT 的预测进行置信度过滤（CONF_THRESH=0.5）。  

**Fusion：**  
对同类别且 IoU ≥ 0.5 的检测框配对，通过 WBF 融合坐标：  
```
b̃ = (Σ c_ST * b_ST + Σ c_DT * b_DT) / (Σ c_ST + Σ c_DT)
c̃ = β * mean(c_ST) + (1-β) * mean(c_DT)
```
其中 β=0.5，平衡静态与动态教师贡献。

### 3.4 EMA 更新（动态教师）
动态教师通过 EMA 更新：  
```
θ_DT ← α * θ_DT + (1-α) * θ_S
```
论文设置 α=0.999（EMA_KEEP_RATE）。

### 3.5 PETS 的优势
1) 静态教师提供稳定参考  
2) 动态教师适应目标域新分布  
3) 共识融合减少噪声  
4) 周期交换提升探索能力  

---

## 4. IRG + PETS 融合机理
PETS 提升伪标签可靠性，IRG 强化结构一致性，两者互补：  
- **PETS**：提高伪标签质量  
- **IRG**：让结构约束更稳定  
最终实现更稳定的 SFOD 适配。

---

## 5. 实验曲线与指标含义
训练中保存的曲线（`checkpoint/foggy/*.png`）具有如下含义：

### 5.1 检测损失
- `loss_total`：整体优化目标  
- `loss_rpn_cls` / `loss_rpn_loc`：RPN 阶段分类与回归  
- `loss_cls` / `loss_box_reg`：ROI 阶段分类与回归  

意义：损失下降说明伪标签训练有效；震荡较大说明噪声仍明显。  

### 5.2 IRG 一致性损失
`st_const`, `s_graph_const`, `t_graph_const`, `graph_conloss`  

意义：这些损失下降或收敛 → 结构一致性增强，训练更稳定。  

### 5.3 AP / AP50 曲线
AP50（mAP@0.5）是最终检测指标。  

意义：AP50 提升或稳定 → 目标域适配有效。  

### 5.4 曲线解读注意事项（建议写进论文图注）
1) **loss_total 与各子损失的同步趋势**  
   - 若 loss_total 下降而 AP50 不升，可能是伪标签偏差被强化。  
2) **IRG 损失与 AP50 的对应**  
   - IRG 损失稳定下降通常伴随 AP50 稳步提升，说明结构一致性起作用。  
3) **AP50 波动的正常性**  
   - 目标域无标注训练中，AP50 往往会阶段性波动，不代表失败。  
4) **Warm-up 阶段解释**  
   - 前 2 个 epoch 仅 EMA 更新，不交换权重，曲线收敛较慢属正常现象。  
5) **趋势图的结论写法**  
   - “loss 曲线整体下降 + AP50 稳定上升”可作为“适配有效”的结论依据。  

---

## 6. 最终结果模型选择
论文明确规定：**评估使用动态教师（DT）**。  
因此最终报告应采用 `model_teacher_*.pth` 的 AP50。

---

## 7. 可直接用于论文的总结段落
本实验在 SFOD 场景下引入 IRG 与 PETS 机制。PETS 通过静态/动态教师协作与周期交换策略生成更可靠的伪标签，IRG 利用实例关系图约束特征一致性，从结构层面抑制伪标签噪声。两者结合显著稳定训练过程并提升目标域检测性能。最终性能以动态教师模型的 AP50 为准，符合文献设定。
